services:
  cre-node:
    build:
      context: ./cre-node
      dockerfile: Dockerfile
    container_name: aegis-oracle-node
    volumes:
      # LIVE VOLUME MAPPING:
      # This maps your local /cre-node folder to the /app folder in the container.
      # Any code changes you make in VS Code are instantly visible to the CRE CLI.
      - ./cre-node:/app
      # Map your root .env so secrets are available for simulation
      - ./.env:/app/.env
      # Map the global CLI credentials so 'cre login' survives rebuilds
      - ~/.cre:/root/.cre
    env_file:
      - .env
    environment:
      - NODE_ENV=development
    # Standard terminal support
    tty: true
    stdin_open: true
    depends_on:
      decompiler:
        condition: service_healthy

  # ── Heimdall Bytecode Decompiler Microservice ─────────────────────────────
  # POST /decompile — accepts { "bytecode": "0x..." }, returns decompiled Solidity
  # Used as fallback when BaseScan has no verified source code for a contract
  decompiler:
    build:
      context: ./services/decompiler
      dockerfile: Dockerfile
    container_name: aegis-decompiler
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # ── LEGACY: Alto ERC-4337 Bundler (local dev only — NOT used in V5 submission)
  # V5 uses Pimlico Cloud Bundler on Base Sepolia. Kept for local Anvil testing.
  alto-bundler:
    image: node:20-alpine
    container_name: aegis-alto-bundler
    env_file:
      - .env
    environment:
      - NODE_ENV=development
    ports:
      - "4337:4337"
    # EntryPoint v0.7 (EIP-4337 canonical) — deployed on Base and most forks
    command: >
      sh -c "npx --yes @pimlico/alto@latest -e 0x0000000071727De22E5E9d8BAf0edAc6f37da032 -r ${BASE_SEPOLIA_RPC_URL} -x ${PRIVATE_KEY} --port 4337 --rpc-gas-estimate"
    # Comment out if you don't want the bundler running alongside the oracle
    profiles:
      - v5
