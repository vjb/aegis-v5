  ðŸ”Ž Checking Tenderly VNet health...
You cannot call a method on a null-valued expression.
At C:\Users\vjbel\hacks\aegis-v4\scripts\demo_2_multi_agent.ps1:31 char:1
+ $blockNum = (cast block-number --rpc-url $RPC 2>$null | Select-Object ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [], RuntimeException
    + FullyQualifiedErrorId : InvokeMethodOnNull
 

  âš ï¸  Tenderly VNet is out of blocks or unreachable.
  ðŸ”„ Auto-provisioning a new VNet via new_tenderly_testnet.ps1...

=======================================================
  ðŸ›¡ï¸  AEGIS V4 â€” NEW TENDERLY TESTNET PROVISIONER
  (ERC-7579 Module Edition)
=======================================================

1. Creating new Tenderly Virtual Testnet (aegis-v4-0227-1407)...
  > VNet ID: c9110334-6407-4968-8f87-8a574b120c41
  > Admin RPC: https://virtual.base.eu.rpc.tenderly.co/fd3b0803-3eea-4603-82c9-245c4bc00209

2. Updating .env with new RPC URL...
  > .env updated

3. Updating CRE-Node YAML configs...
  > Updated cre-node/workflow.yaml
  > Updated cre-node/project.yaml

4. Funding deployer wallet via Tenderly cheatcode...
  > Deployer funded with 2 ETH (enough for all demo operations)

5. Deploying AegisModule (ERC-7579 Executor)...
  > AegisModule deployed at: 0x46d40e0aBdA0814bb0CB323B2Bb85a129d00B0AC

6. Updating AEGIS_MODULE_ADDRESS in .env...
  > AEGIS_MODULE_ADDRESS updated in .env

7. Updating cre-node/config.json with AegisModule address...
  > config.json updated (vaultAddress â†’ AegisModule)

8. Verifying AegisModule on Tenderly explorer...
  > AegisModule verified on Tenderly

=======================================================
  ðŸŽ‰ AEGIS V4 TESTNET READY
=======================================================
  RPC:    https://virtual.base.eu.rpc.tenderly.co/fd3b0803-3eea-4603-82c9-245c4bc00209
  Module: 0x46d40e0aBdA0814bb0CB323B2Bb85a129d00B0AC
  UUID:   fd3b0803-3eea-4603-82c9-245c4bc00209
=======================================================

  NEXT STEPS:
  1. Run E2E sim:   npx ts-node scripts/e2e_mock_simulation.ts
  2. Run live E2E:  npx ts-node scripts/live_e2e.ts
  3. Start Oracle:  .\scripts\start_oracle.ps1
  4. Start UI:      cd aegis-frontend && npm run dev

  âœ… New VNet ready. RPC: https://virtual.base.eu.rpc.tenderly.co/fd3b0803-3eea-4603-82c9-245c4bc00209


======================================================================
  AEGIS PROTOCOL V4  *  DEMO 2: THE FIREWALL THAT RUNS ITSELF
======================================================================

  Targets:  Risk & Compliance (16K) | DeFi & Tokenization (20K)

  Three AI agents. Three trade intents. One firewall.
  No human approval. The Chainlink CRE oracle IS the compliance desk.

  NOVA   (0.05 ETH budget) => wants BRETT        => CLEARED => real swap
  CIPHER (0.01 ETH budget) => wants TaxToken     => BLOCKED (riskScore=2)
  REX    (0.01 ETH budget) => wants HoneypotCoin => BLOCKED (riskScore=5) + bypass revert

  AegisModule: 0x46d40e0aBdA0814bb0CB323B2Bb85a129d00B0AC

  [1a] Funding treasury with 0.1 ETH...
  OK  Treasury funded: 0.1 ETH
  [1b] Funding agent gas wallets via Tenderly faucet...
  OK  Agent gas wallets funded (Tenderly testnet faucet)
  [1c] Subscribing NOVA with 0.05 ETH budget...
  OK  NOVA hired | AgentSubscribed(NOVA, 50000000000000000) emitted
  [1d] Subscribing CIPHER with 0.01 ETH budget...
  OK  CIPHER hired | AgentSubscribed(CIPHER, 10000000000000000) emitted
  [1e] Subscribing REX with 0.01 ETH budget...
  OK  REX hired | AgentSubscribed(REX, 10000000000000000) emitted
  [2a] NOVA => requestAudit(BRETT)...
  OK  NOVA => tradeId=0 | 0xdf2f55b5159c297bbc5eb2e5e629a62fd9dbd0606536a8e1029558685a438d97
  [2b] CIPHER => requestAudit(TaxToken)...
  OK  CIPHER => tradeId=1 | 0xa873160896057c8177d46846377b7bb057f92c9d1ab17cc65fa4c3cca8762291
  [2c] REX => requestAudit(HoneypotCoin)...
  OK  REX => tradeId=2 | 0xfbf837c774524975d58ac5cb1b36dd778f8070d519e4f2bff8002a3922c8b914

  All three intents are queued.
  Running Chainlink CRE oracle for each token...

  --------------------------------------------------------------------
  ðŸ”— CHAINLINK CRE â€” WASM SANDBOX OUTPUT (ALL 3 AGENTS)
  --------------------------------------------------------------------

  --- CRE: BRETT ---
    __GOPLUS_START__
    [GoPlus] Authenticating with ConfidentialHTTPClient (APP_KEY stays in DON)...
    [GoPlus] JWT acquired â€” AEGIS_GOPLUS_KEY stays inside the Decentralized Oracle Network
    [GoPlus] Fetching token_security for 0x532f27101965dd16442e59d40670faf5ebb142e4 (auth=false) via ConfidentialHTTPClient
    [GoPlus] HTTP 200
    [GoPlus] unverified=0 sellRestriction=0 honeypot=0 proxy=0
    [BaseScan] ConfidentialHTTPClient â†’ BaseScan for 0x532f27101965dd16442e59d40670faf5ebb142e4
    [BaseScan] AEGIS_BASESCAN_SECRET stays inside the Decentralized Oracle Network
    [BaseScan] HTTP 200 â€” key never left DON
    [BaseScan] Contract: BrettToken | 52963 chars of Solidity
    [AI] â†’ GPT-4o via ConfidentialHTTPClient | AEGIS_OPENAI_SECRET stays in DON
    [GPT-4o] HTTP 200
  CRE verdict: BRETT => riskCode=0

  --- CRE: TaxToken ---
    [GoPlus] MOCK registry hit: TaxToken
    [GoPlus] unverified=0 sellRestriction=1 honeypot=0
    [AI] â†’ GPT-4o via ConfidentialHTTPClient | AEGIS_OPENAI_SECRET stays in DON
    [GPT-4o] HTTP 200
    [GPT-4o] Response:
    [GPT-4o] Risk bits â†’ tax=true priv=false extCall=false bomb=false honeypot=false
    [GPT-4o] Reasoning: The contract implements an obfuscated 99% sell fee disguised as a 'protocol fee', which exceeds the firewall's maxTax limit and is not clearly named as a tax or fee.
    [AI] â†’ Llama-3 via Groq ConfidentialHTTPClient | AEGIS_GROQ_SECRET stays in DON
    [Llama-3] HTTP 200
    [Llama-3] Response: {
    [Llama-3] Risk bits â†’ tax=true priv=false extCall=false bomb=false honeypot=false
    [Llama-3] Reasoning: The contract deducts a 99% 'protocol fee' from transfers, which is not clearly named 'tax' or 'fee'.
    [AI] Union of Fears â†’ obfuscatedTax=1 privilegeEscalation=0 externalCallRisk=0 logicBomb=0 honeypotPattern=0
    âš–ï¸ Final Risk Code: 18
    â›” GoPlus â€” static analysis raised flag
    â›” GPT-4o â€” read Solidity source, found malicious pattern
    â›” Llama-3 â€” independently confirmed (second AI brain)
    â˜… AI models caught this â€” reading real contract source, not just GoPlus signals
  CRE verdict: TaxToken => riskCode=18

  --- CRE: HoneypotCoin ---
    [GoPlus] MOCK registry hit: HoneypotCoin
    [GoPlus] unverified=0 sellRestriction=0 honeypot=1
    [BaseScan] Using MOCK source for HoneypotCoin (1070 chars)
    [AI] Contract under audit: HoneypotCoin
    [AI] â†’ GPT-4o via ConfidentialHTTPClient | AEGIS_OPENAI_SECRET stays in DON
    [GPT-4o] HTTP 200
    [GPT-4o] Response: {
    [GPT-4o] Risk bits â†’ tax=false priv=false extCall=false bomb=false honeypot=true
    [GPT-4o] Reasoning: The contract restricts token transfers to an owner-controlled allowlist, making it impossible for non-approved users to sell their tokens, which is a honeypot pattern.
    [AI] â†’ Llama-3 via Groq ConfidentialHTTPClient | AEGIS_GROQ_SECRET stays in DON
    [Llama-3] HTTP 200
    [Llama-3] Response: {
    [Llama-3] Risk bits â†’ tax=false priv=false extCall=false bomb=false honeypot=true
    [Llama-3] Reasoning: The contract restricts token transfers to an owner-controlled allowlist, making it impossible for non-approved users to sell their tokens.
    [AI] Union of Fears â†’ obfuscatedTax=0 privilegeEscalation=0 externalCallRisk=0 logicBomb=0 honeypotPattern=1
    âš–ï¸ Final Risk Code: 260
    â›” GoPlus â€” static analysis raised flag
    â›” GPT-4o â€” read Solidity source, found malicious pattern
    â›” Llama-3 â€” independently confirmed (second AI brain)
    â˜… AI models caught this â€” reading real contract source, not just GoPlus signals
  CRE verdict: HoneypotCoin => riskCode=260


  --------------------------------------------------------------------

  [3a] BRETT cleared (tradeId=0, riskScore=0)...
  OK  ClearanceUpdated(BRETT, true) => NOVA is GO for launch
  [3b] TaxToken blocked (tradeId=1, riskScore=18, bit 1 = sell restriction)...
  BLOCKED  ClearanceDenied(TaxToken, 18) => CIPHER stands down
  [3c] HoneypotCoin blocked (tradeId=2, riskScore=260, bits 0+2)...
  BLOCKED  ClearanceDenied(HoneypotCoin, 260) => REX denied

  Union of Fears: if EITHER model flags a risk, the bit is set.
  BRETT's real source was read by both GPT-4o and Llama-3 from BaseScan.
  TaxToken/HoneypotCoin: full Solidity source sent to AI from MOCK_REGISTRY.
  [4a] NOVA executing real Uniswap V3 swap...
  >   cast send AegisModule 'triggerSwap(address,uint256,uint256)' BRETT 10000000000000000 1 --pk NOVA
  OK  Swap transaction confirmed on-chain
  >>  Tenderly trace: https://virtual.base.eu.rpc.tenderly.co/fd3b0803-3eea-4603-82c9-245c4bc00209/tx/0x73d7cf19edb5ba9f8548fbbf34cca645ad2f9b2bf4c3d756320301ad657503e7
  >>  AegisModule BRETT balance: 0x000000000000000000000000000000000000000000000095238da9debc74e9f8
  >>  NOVA remaining budget: 0x000000000000000000000000000000000000000000000000008e1bc9bf040000 (raw wei)
  [5a] REX tries triggerSwap with NO clearance...
  REVERT: TokenNotCleared â€” REX bypass failed
  OK  Contract held. No clearance = no swap. On-chain enforcement works.
  [5b] Owner fires REX: revokeAgent(REX)...
  OK  AgentRevoked(REX) emitted. Budget = 0.
  [5c] Proving REX lockout â€” REX attempts requestAudit after revoke...
  REVERT: NotAuthorized â€” REX has zero access. Kill switch confirmed.

======================================================================
  DEMO 2 COMPLETE â€” MULTI-AGENT FIREWALL VERIFIED
======================================================================

  AGENT    TOKEN            RISK CODE  CAUGHT BY                   RESULT
  -------  ---------------  ---------  --------------------------  ------
  NOVA     BRETT             0 (clean) GoPlus + GPT-4o + Llama-3  OK  Swap executed
  CIPHER   TaxToken         16+2 = 18  GoPlus + GPT-4o + Llama-3  BLOCKED: obfuscated 99% tax
  REX      HoneypotCoin       bit 2 = 4  GoPlus (honeypot flag)     BLOCKED: honeypot detected
  REX      (bypass attempt)  n/a         Contract enforcement        REVERT: TokenNotCleared
  REX      (post-revoke)     n/a         Kill switch                 REVERT: NotAuthorized

  TaxToken: BOTH GPT-4o and Llama-3 read malicious Solidity and flagged obfuscated tax.
  HoneypotCoin: GoPlus static flag (honeypot=1). AI confirmed but did not independently flag.
  Union of Fears: token blocked if EITHER source raises a flag.

  ConfidentialHTTPClient: GoPlus + BaseScan + OpenAI + Groq keys NEVER left the DON.

