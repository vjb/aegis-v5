PASS test/bot.spec.ts (58.67 s)
  AegisAgent V5 â€” ERC-4337 Bot
    âˆš validates required config fields exist (22 ms)
    âˆš requestAudit calldata contains target token address (3 ms)
    âˆš triggerSwap calldata contains token address and 1 ETH amount (5 ms)
    âˆš agent design: gas wallet is separate from Smart Account (capital custody) (13 ms)
    âˆš risk matrix bit decoding identifies correct flags (3 ms)
    âˆš polling returns false if no clearance event after timeout (34 ms)

PASS test/oracle.spec.ts (59.021 s)
  Aegis CRE Oracle V5 â€” ABI encoding
    âˆš encodes (tradeId=3, riskScore=0) to 64-byte ABI-encoded hex (46 ms)
    âˆš encodes (tradeId=0, riskScore=4) â€” honeypot flag (2 ms)
    âˆš encodes riskScore=255 (all risk bits set) (1 ms)
    âˆš oracle config vaultAddress points to AegisModule (3 ms)
    âˆš V5 config shape has required CRE fields (4 ms)
    âˆš V3 and V5 onReport ABI encoding is identical (same uint256,uint256 schema) (28 ms)
  Oracle AI JSON â†’ onReportDirect hex payload (5.5.3)
    âˆš AI response {"risk": 5} â†’ correct hex payload for onReportDirect (4 ms)
    âˆš AI response {"risk": 0} â†’ approved (clean token) (4 ms)
    âˆš AI response {"risk": 36} â†’ denied (honeypot + privilege escalation) (8 ms)
    âˆš calldata length is always exactly 138 chars (4+32+32 bytes) (55 ms)

PASS test/frontend.spec.ts (60.852 s)
  Phase 8.1 â€” Wallet Info + Session Key Rendering
    âˆš WalletInfo type has all required fields (23 ms)
    âˆš truncates owner address to 0x109Dâ€¦65Cf (2 ms)
    âˆš truncates module address correctly (1 ms)
    âˆš session key targets only the AegisModule (1 ms)
    âˆš session key allows exactly 2 selectors (3 ms)
    âˆš session key allows requestAudit (0xe34eac65) (2 ms)
    âˆš session key allows triggerSwap (0x684bceb0) (6 ms)
    âˆš session key does NOT allow transfer selector (2 ms)
    âˆš session key budget is capped at 0.002 ETH (2 ms)
    âˆš error field is optional in WalletInfo (3 ms)
  Phase 8.2 â€” Oracle Feed: Risk Score & Verdict Logic
    âˆš risk score 0 decodes to 8 all-clean checks (2 ms)
    âˆš risk score 0 â†’ APPROVED verdict (2 ms)
    âˆš risk score 4 (bit 2) â†’ Known Honeypot flagged (2 ms)
    âˆš risk score 4 â†’ BLOCKED (2 ms)
    âˆš risk score 36 = Honeypot (bit 2) + Privilege Escalation (bit 5) (2 ms)
    âˆš risk score 255 flags all 8 bits (1 ms)
    âˆš risk score 1 (bit 0) â†’ Unverified Code only (2 ms)
    âˆš risk score 16 (bit 4) â†’ Obfuscated Tax only (1 ms)
    âˆš risk score 128 (bit 7) â†’ Logic Bomb only (2 ms)
    âˆš negative score â†’ ERROR verdict (2 ms)
  Phase 8.2 â€” Oracle Feed: SSE Event Parsing
    âˆš parses phase event (2 ms)
    âˆš parses tx event with hash (1 ms)
    âˆš parses final_verdict BLOCKED event (1 ms)
    âˆš parses final_verdict APPROVED event (5 ms)
    âˆš parses llm-reasoning-start for GPT-4o (1 ms)
    âˆš parses static-analysis GoPlus event (1 ms)

  console.log
    [TEST] Live bytecode for AegisModule: 19666 hex chars

      at Object.<anonymous> (test/cre/HeimdallLive.spec.ts:120:17)

  console.log
    [TEST] Step 1: Fetched 19666 hex chars from Base Sepolia

      at Object.<anonymous> (test/cre/HeimdallLive.spec.ts:169:17)

FAIL test/cre/HeimdallLive.spec.ts (64.232 s)
  Phase 2: Live Heimdall Microservice
    Ã— GET /health should return ok with Heimdall version (390 ms)
    Ã— POST /decompile should return decompiled logic for known bytecode (601 ms)
    Ã— POST /decompile should reject empty bytecode (30 ms)
  Phase 3: Live Base Sepolia Pipeline
    âˆš should fetch live bytecode from Base Sepolia via eth_getCode (244 ms)
    Ã— should fetch bytecode AND decompile via full pipeline (77 ms)
  Phase 4: Live LLM Consensus Integration
    Ã— should send Heimdall-decompiled code to live GPT-4o and get valid risk JSON (80 ms)

  â— Phase 2: Live Heimdall Microservice â€º GET /health should return ok with Heimdall version

    TypeError: fetch failed

    [0m [90m 27 |[39m     [36mconst[39m timer [33m=[39m setTimeout(() [33m=>[39m controller[33m.[39mabort()[33m,[39m timeoutMs)[33m;[39m
     [90m 28 |[39m     [36mtry[39m {
    [31m[1m>[22m[39m[90m 29 |[39m         [36mreturn[39m [36mawait[39m fetch(url[33m,[39m { [33m...[39mopts[33m,[39m signal[33m:[39m controller[33m.[39msignal })[33m;[39m
     [90m    |[39m                [31m[1m^[22m[39m
     [90m 30 |[39m     } [36mfinally[39m {
     [90m 31 |[39m         clearTimeout(timer)[33m;[39m
     [90m 32 |[39m     }[0m

      at fetchWithTimeout (test/cre/HeimdallLive.spec.ts:29:16)
      at Object.<anonymous> (test/cre/HeimdallLive.spec.ts:60:21)

    Cause:
    AggregateError:


  â— Phase 2: Live Heimdall Microservice â€º POST /decompile should return decompiled logic for known bytecode

    TypeError: fetch failed

    [0m [90m 27 |[39m     [36mconst[39m timer [33m=[39m setTimeout(() [33m=>[39m controller[33m.[39mabort()[33m,[39m timeoutMs)[33m;[39m
     [90m 28 |[39m     [36mtry[39m {
    [31m[1m>[22m[39m[90m 29 |[39m         [36mreturn[39m [36mawait[39m fetch(url[33m,[39m { [33m...[39mopts[33m,[39m signal[33m:[39m controller[33m.[39msignal })[33m;[39m
     [90m    |[39m                [31m[1m^[22m[39m
     [90m 30 |[39m     } [36mfinally[39m {
     [90m 31 |[39m         clearTimeout(timer)[33m;[39m
     [90m 32 |[39m     }[0m

      at fetchWithTimeout (test/cre/HeimdallLive.spec.ts:29:16)
      at Object.<anonymous> (test/cre/HeimdallLive.spec.ts:75:21)

    Cause:
    AggregateError:


  â— Phase 2: Live Heimdall Microservice â€º POST /decompile should reject empty bytecode

    TypeError: fetch failed

    [0m [90m 27 |[39m     [36mconst[39m timer [33m=[39m setTimeout(() [33m=>[39m controller[33m.[39mabort()[33m,[39m timeoutMs)[33m;[39m
     [90m 28 |[39m     [36mtry[39m {
    [31m[1m>[22m[39m[90m 29 |[39m         [36mreturn[39m [36mawait[39m fetch(url[33m,[39m { [33m...[39mopts[33m,[39m signal[33m:[39m controller[33m.[39msignal })[33m;[39m
     [90m    |[39m                [31m[1m^[22m[39m
     [90m 30 |[39m     } [36mfinally[39m {
     [90m 31 |[39m         clearTimeout(timer)[33m;[39m
     [90m 32 |[39m     }[0m

      at fetchWithTimeout (test/cre/HeimdallLive.spec.ts:29:16)
      at Object.<anonymous> (test/cre/HeimdallLive.spec.ts:94:21)

    Cause:
    AggregateError:


  â— Phase 3: Live Base Sepolia Pipeline â€º should fetch bytecode AND decompile via full pipeline

    TypeError: fetch failed

    [0m [90m 27 |[39m     [36mconst[39m timer [33m=[39m setTimeout(() [33m=>[39m controller[33m.[39mabort()[33m,[39m timeoutMs)[33m;[39m
     [90m 28 |[39m     [36mtry[39m {
    [31m[1m>[22m[39m[90m 29 |[39m         [36mreturn[39m [36mawait[39m fetch(url[33m,[39m { [33m...[39mopts[33m,[39m signal[33m:[39m controller[33m.[39msignal })[33m;[39m
     [90m    |[39m                [31m[1m^[22m[39m
     [90m 30 |[39m     } [36mfinally[39m {
     [90m 31 |[39m         clearTimeout(timer)[33m;[39m
     [90m 32 |[39m     }[0m

      at fetchWithTimeout (test/cre/HeimdallLive.spec.ts:29:16)
      at Object.<anonymous> (test/cre/HeimdallLive.spec.ts:129:21)

    Cause:
    AggregateError:


  â— Phase 4: Live LLM Consensus Integration â€º should send Heimdall-decompiled code to live GPT-4o and get valid risk JSON

    TypeError: fetch failed

    [0m [90m 27 |[39m     [36mconst[39m timer [33m=[39m setTimeout(() [33m=>[39m controller[33m.[39mabort()[33m,[39m timeoutMs)[33m;[39m
     [90m 28 |[39m     [36mtry[39m {
    [31m[1m>[22m[39m[90m 29 |[39m         [36mreturn[39m [36mawait[39m fetch(url[33m,[39m { [33m...[39mopts[33m,[39m signal[33m:[39m controller[33m.[39msignal })[33m;[39m
     [90m    |[39m                [31m[1m^[22m[39m
     [90m 30 |[39m     } [36mfinally[39m {
     [90m 31 |[39m         clearTimeout(timer)[33m;[39m
     [90m 32 |[39m     }[0m

      at fetchWithTimeout (test/cre/HeimdallLive.spec.ts:29:16)
      at Object.<anonymous> (test/cre/HeimdallLive.spec.ts:172:30)

    Cause:
    AggregateError:


PASS test/session_key.spec.ts (72.717 s)
  getSmartSessionValidatorModule (unit)
    âˆš returns type=validator (not executor) (20 ms)
    âˆš has the canonical SmartSessions validator address (2 ms)
  AegisModule function selectors (unit)
    âˆš requestAudit(address) selector is 4 bytes (2 ms)
    âˆš triggerSwap(address,uint256,uint256) selector is 4 bytes (6 ms)
    âˆš selectors are distinct (no collision) (4 ms)
  buildAgentSession (unit)
    âˆš specifies the SmartSessions validator as session validator (10 ms)
    âˆš encodes agent address in sessionValidatorInitData (4 ms)
    âˆš permits exactly 2 actions (requestAudit + triggerSwap) (6 ms)
    âˆš first action targets AegisModule with requestAudit selector (3 ms)
    âˆš second action targets AegisModule with triggerSwap selector (5 ms)
    âˆš has a 32-byte salt (3 ms)
  SESSION_MODES (unit)
    âˆš USE mode = 0x00 (agent presents existing signed session) (1 ms)
    âˆš ENABLE mode = 0x01 (agent enables + uses in same UserOp) (1 ms)
    âˆš UNSAFE_ENABLE mode = 0x02 (skip policy checks â€” dev only) (1 ms)

PASS test/bot_v5.spec.ts (72.693 s)
  buildV5RequestAuditCall (unit)
    âˆš targets AegisModule (NOT the Safe directly) (22 ms)
    âˆš attaches zero ETH value (treasury pays, not the agent) (2 ms)
    âˆš encodes requestAudit(address) selector correctly (2 ms)
    âˆš encodes the token address as the only argument (3 ms)
  buildV5TriggerSwapCall (unit)
    âˆš targets AegisModule (5 ms)
    âˆš attaches zero ETH value (module treasury provides ETH for swaps) (4 ms)
    âˆš encodes triggerSwap(address,uint256,uint256) â€” 3 params (3 ms)
    âˆš defaults amountOutMinimum to 1 (contract requires non-zero) (17 ms)
    âˆš is distinct from requestAudit calldata (different selector) (3 ms)
  Legacy vs V5 call structure
    âˆš V5 triggerSwap has 3 params, legacy bot.ts ABI had only 2 (bug fixed) (2 ms)
  ERC-7715 Session Key Constraints (5.5.2)
    âˆš session key targets ONLY the AegisModule address (10 ms)
    âˆš session permits exactly 2 selectors: requestAudit + triggerSwap (3 ms)
    âˆš session DOES NOT permit arbitrary function selectors (e.g. ETH drain) (2 ms)
    âˆš session DOES NOT permit calling a random contract (only AegisModule) (1 ms)
    âˆš session uses the SmartSessionsValidator (Rhinestone canonical) (1 ms)
    âˆš session key = agent public address (embedded in initData) (2 ms)

PASS test/safe_setup.spec.ts (15.345 s)
  buildSafeConfig (unit)
    âˆš returns a config with the correct owner and entry point (8 ms)
    âˆš starts with threshold 1 (single-owner Safe) (2 ms)
  buildAegisModuleConfig (unit)
    âˆš returns type='executor' (ERC-7579 TYPE_EXECUTOR = 2) (7 ms)
    âˆš sets module address correctly (2 ms)
    âˆš has zero initData for AegisModule (onInstall is a no-op) (2 ms)
  constants (unit)
    âˆš ENTRYPOINT_V07 matches canonical ERC-4337 v0.7 address (2 ms)
  deploySafeWithAegisModule (integration â€” requires BASE_SEPOLIA_RPC_URL)
    â—‹ skipped deploys a Safe and installs AegisModule as ERC-7579 Executor

PASS test/session_install.spec.ts (75.6 s)
  SmartSessionValidator Integration (Base Sepolia)
    âˆš SmartSessionValidator is installed on Safe as validator module (13 ms)
    âˆš AegisModule is still installed as executor module (2 ms)
    âˆš Agent wallet is subscribed with non-zero budget (1 ms)
    âˆš Agent can requestAudit via UserOp (session key scoped) (1 ms)
    âˆš Agent can triggerSwap via UserOp after clearance (1 ms)
    âˆš Agent cannot call withdrawETH (not in session scope) (1 ms)
    âˆš Agent cannot call revokeAgent (not in session scope) (1 ms)
    âˆš buildAgentSession produces valid session for agent (1 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Test Suites: 1 failed, 7 passed, 8 total
Tests:       5 failed, 1 skipped, 87 passed, 93 total
Snapshots:   0 total
Time:        78.095 s, estimated 357 s
Ran all test suites.
